#!/bin/sh

# ------------------------------------------------------------------------------

# utils

warn () { echo "$1" >/dev/stderr; }
info () { echo "$1" >/dev/stderr; }
err () { echo "$1" >/dev/stderr; exit 1; }
arg () { test "x$2" != "x" && echo "$2" || err "Missing argument for \`$1'!"; }

# arg. parsing

while test $# '>' 0; do
    case "$1" in
	*) warn "Ignoring argument \`$1'!"; shift;;
    esac;
done;

# ---

# output config file
exec 1>"Makefile.config";
cat Makefile.config.in;

maybe_cmd () {
    command -v $2 >/dev/null && echo "$1 = $2" || warn "$3 seems unavailable";
}

system=$(uname -s);
info "Detected System: ${system}"; 
case "${system}" in
    Linux)  
	:;;			# <- defaults are ok.
    Darwin|FreeBSD) 
	echo 'GMP_PREFIX = /usr/local';
	echo 'MPFR_PREFIX = /usr/local';
	maybe_cmd "SED" "gsed" "GNU sed";;
    *)
	err "Unknown System!";;
esac;

overs=$(ocamlc -version);
case "${overs}" in
    # not sure what versions are relevant here...:
    [12].* | 3.[1-9].* | 3.10.*)
	warn "OCaml version found is ${overs}: plugins will NOT be built.";
	echo 'HAS_NATIVE_PLUGINS =';;
    *)
	info "OCaml version found is ${overs}: plugins will be built.";
	echo 'HAS_NATIVE_PLUGINS = 1';;
    *)
esac

# ------------------------------------------------------------------------------
